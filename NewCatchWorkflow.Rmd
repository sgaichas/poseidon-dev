---
title: "New catch functions from CATCH.nc file"
author: "Sarah Gaichas"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    code_fold: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(here)
library(stringr)
library(magrittr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(atlantisom)
```


## Intro

Total catch in tons has been pulled from the Atlantis `Catch.txt` output file from 2019-2023 due to difficulties scaling catch in numbers from the `CATCH.nc` file to total weight. See comparisons [here](https://sgaichas.github.io/poseidon-dev/TestCatchNOBA.html). 

For testing multispecies models, there is a need for subannual catch information, which is not provided in the annual `Catch.txt` output. In addition, there is no polygon information in the `Catch.txt` output, so spatial subsetting is not possible.

In order to get catch in tons subannually and by area, we can use the fleet-specific catch information in the `CATCH.nc` file. These outputs are reported in tons by species in aggregate over all age classes for each defined fleet.

## Methods

Workflow

1.  Modify `atlantisom::load_nc` to get catch in tons from different `CATCH.nc` outputs. New function because current function already gets catch in numbers, would be complicated to use the same "Catch" variable to get tons. Name new function `atlantisom::load_nc_catchtons`

2.  Test new `atlantisom::load_nc_catchtons` with NOBA, NEUS, CC by summing output over polygons and fleets to each year and comparing with annual output of current `atlantisom::load_catch` based on `Catch.txt`

3.  Incorporate `atlantisom::load_nc_catchtons` into `atlantisom::run_truth`. Add a new catchtons object keeping polygon, timestep, and fleet information to the output list. Consider removing the `Catch.txt` output in this function, currently called `catch_all` but not used? Or keep it, since catchtons can be summed to catch_all this could be used as an internal test as was started in the run_truth function. 

4.  Adjust `atlantisom::om_init` for the new catchtons output. Should we keep reading in the `Catch.txt` here? It may be ok to keep it just to keep existing functions for aggregate annual catch working.

5.  Adjust `atlantisom::om_species` for the new catchtons output. 

6.  Adjust `atlantisom::om_index` for the new catchtons output. Create a new index that will be consistent across the subannual and annual datasets: this means applying the cv at the level of reporting? So possibly by fleet and timestep, then summing to annual? This involves including and updating two functions: `atlantisom::create_fishery_subset` parallel to the `atlantisom::create_survey` function to subset areas, currently used only on fishery comps but can now be applied to the index as well, and updating another `atlantisom::sample_fishery_totalcatch` for the cv application. This will save perhaps one new output and update one existing output, or just one output? Will we have the same current `censusfishCatch.rds` output that is annually aggregated plus a disaggregated version? Or have a single output with the same name `censusfishCatch.rds` that is disaggregated, to be summed separately in mskeyrun?

7. Adjust `mskeyrun` functions creating aggregated and subannual catch datasets. Do we need a fleet specific index?


### 1. New `atlantisom::load_nc_catchtons` function

Here is the new function, tested with snippets in mskeyrun sarah_wgsamsim branch and implemented in atlantisom dev branch

```{r, code = readLines("https://raw.githubusercontent.com/r4atlantis/atlantisom/dev/R/load_nc_catchtons.R"), eval=F}
```


### 2. Test `load_nc_catchtons` with the NOBA, NEUS, CC model outputs

For all plots, the total catch derived from Catch.txt is considered correct, and is represented by the black line. The total catch summed across polygon, subannual timestep and fleet is in blue. 

Only NOBA first, this one is model sacc30 with climate, different from sacc38 in `mskeyrun` without climate: 

```{r, message=FALSE, warning=FALSE}

# define for each model

## NOBA (different from mskeyrun version)

atlmod <- here("config/NOBAsacc30Config.R")

select_groups <- c("Long_rough_dab",
                   "Green_halibut",
                   "Mackerel",
                   "Haddock",
                   "Saithe",
                   "Redfish",
                   "Blue_whiting",
                   "Norwegian_ssh",
                   "North_atl_cod",
                   "Polar_cod",
                   "Capelin")

stepperyr <- 5



## NEUS



##### aggregate over polygons to fleets #######
# make this a function

comparecatch <- function(atlmod, select_groups, stepperyr) {
  source(atlmod, local = TRUE)
  
  dir <- d.name
  nc_catch <- paste0(scenario.name, 'CATCH.nc')
  file_fgs <- functional.groups.file
  file_init <- initial.conditions.file
  file_fish <- fisheries.file
  
  # Get the boundary boxes
  allboxes <- atlantisom::load_box(dir = d.name, file_bgm = box.file)
  boxes <- atlantisom::get_boundary(allboxes)
  
  
  # Read in information
  # Read in the functional groups csv since that is used by many functions
  fgs <- load_fgs(dir = dir, file_fgs = file_fgs)
  # Read in the biomass pools
  bps <- load_bps(dir = dir,
                  fgs = file_fgs,
                  file_init = file_init)
  
  catchtons <- load_nc_catchtons(
    dir = dir,
    file_nc = nc_catch,
    file_fish = file_fish,
    bps = bps,
    fgs = fgs,
    select_groups = select_groups,
    select_variable = "Catch",
    check_acronyms = TRUE,
    bboxes = boxes
  )
  #if(verbose) message("Catch tons read in.")
  
  # result is output of load_nc_catchtons
  
  aggcatchtons <- catchtons %>%
    dplyr::select(-agecl) %>%
    dplyr::group_by(species, fleet, time) %>%
    dplyr::summarise(totcatch = sum(atoutput)) %>%
    dplyr::mutate(year = ceiling(time / stepperyr))
  
  # compare annual catch in tons to Catch.txt output
  yearcatchtons <- aggcatchtons %>%
    dplyr::group_by(species, year) %>%
    dplyr::summarise(yeartot = sum(totcatch))
  
  txtCatchtons <- atlantisom::load_catch(d.name, catch.file, fgs) %>%
    dplyr::filter(species %in% select_groups) %>%
    dplyr::mutate(year = time / 365) %>%
    dplyr::left_join(dplyr::select(fgs, Code, Name), by = c("species" = "Name"))
  
  comparetons <- txtCatchtons %>%
    dplyr::left_join(yearcatchtons, by = c("Code" = "species", "year" = "year")) %>%
    ggplot2::ggplot() +
    geom_line(aes(year, atoutput)) +
    geom_point(aes(year, yeartot), color = "blue", alpha = 0.2) +
    facet_wrap( ~ species, scales = "free_y")
  
  # looks like a match!
  comparetons
  
}

comparecatch(atlmod = atlmod, 
             select_groups = select_groups,
             stepperyr = stepperyr)

```

Now try the Isaac's recent CC model:

```{r, message=FALSE, warning=FALSE}
## CC

atlmod <- here("config/CCConfigSep22.R")

select_groups <- c("Arrowtooth_flounder",
                   "Petrale_sole",
                   "Pacific_sardine",
                   "Anchovy",
                   "Herring",
                   "Pacific_Ocean_Perch",
                   "Bocaccio_rockfish",
                   "Yelloweye_rockfish",
                   "Mesopel_M_Fish", #Pacific hake
                   "Mesopel_N_Fish", #Sablefish
                   "Demersal_P_Fish") #Dover sole

stepperyr <- 5

comparecatch(atlmod = atlmod, 
             select_groups = select_groups,
             stepperyr = stepperyr)
```

And finally the NEUS model, thanks to Joe for output files: 

```{r, message=FALSE, warning=FALSE}
## NEUS
atlmod <- here("config/NEUStestConfigMay23.R")

select_groups <- c("Summerflounder",
                   "Winterflounder",
                   "Mackerel",
                   "Herring",
                   "Cod",
                   "Monkfish",
                   "Haddock",
                   "Spiny_Dogfish",
                   "Winter_Skate",
                   "Yellowtail_Flounder",
                   "Silver_Hake")

stepperyr <- 5

comparecatch(atlmod = atlmod, 
             select_groups = select_groups,
             stepperyr = stepperyr)

```

Looks like we have a match to Catch.txt output for all systems using the same function and inputs from the CATCH.nc file. However, it looks like there is a final value in Catch.txt that is not present, or not being summed correctly in the CATCH.nc output in the CC and NEUS models. Worth investigating...

### 3. Incorporate new `load_nc_catchtons` function into `atlantisom::run_truth`

Added catchtons and disctons (same function with `select_variable = "Discards"`) to `run_truth` in the atlantisom dev branch. At present, catchtons and disctons are in the run_truth output and catch_all which was originally from the `Catch.txt` file have been removed from the output. Sections of the function that read in both the `Catch.txt` and the `CatchPerFishery.txt` files have been commented out. They could be reinstated if needed, but `om_init` reads in `Catch.txt` already and seems like a good place to read in text files. 

Here is the new function, tested by re-running the code in `SimData.Rmd` in the mskeyrun repo using the NOBA sacc38 outputs. The new runtruth object includes the new catchtons and disctons (0) objects. 

```{r, code = readLines("https://raw.githubusercontent.com/r4atlantis/atlantisom/dev/R/run_truth.R"), eval=F}
```

### 4.  Adjust `atlantisom::om_init` for the new catchtons output


